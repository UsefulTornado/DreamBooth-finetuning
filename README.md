# Stable Diffusion fine-tuning with DreamBooth and LoRA

В данном репозитории рассматривается метод fine-tuning'а диффузионных моделей [DreamBooth](https://arxiv.org/pdf/2208.12242.pdf) с использованием [LoRA](https://arxiv.org/pdf/2106.09685.pdf).

Для fine-tuning'а модели использовался [скрипт](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/train_dreambooth_lora.py) `train_dreanbooth_lora.py` из библиотеки diffusers.

В файле `train.ipynb` находится код для запуска скрипта.

В файле `report.ipynb` содержится описание проведённых экспериментов. Также этот ноутбук с отображением выходных значений ячеек можно найти по [ссылке](https://drive.google.com/file/d/1Bt-3hR2ut-EXywQWX3xhMrf-y9elNyLT/view?usp=sharing) в Google Colab.


## Аннотация

### Subject-Driven Generation

Задача генерации изображений на основе текста в последнее время очень популярна. Последние исследования в этой области привели к созданию моделей, которые способны на основе текста генерировать разнообразные фотореалистичные изображения высокого качества. Однако большинство этих моделей, хоть и могут генерировать изображения в различных сценариях, не способны генерировать конкретные предметы в разнообразных контекстах, что объясняется сложностью данной задачи.

Итак, большинство моделей не могут генерировать детализированные изображения нужного объекта. Основная причина заключается в том, что их выразительность ограничена: даже самое подробное текстовое описание объекта приводит к генерации экземпляров с различным внешним видом, то есть модели не могут сохранить идентичность объектов, а только создают их вариации. Рендеринг таких воображаемых сцен - сложная задача, требующая синтеза конкретных объектов (например, предметов или животных) в новых контекстах таким образом, чтобы они естественно и органично вписывались в сцену. Генерация с упором на сохранение деталей предмета открывает возможности для многих приложений, таких как изменение контекста, стиля, точки наблюдения, свойств и др.

### DreamBooth

DreamBooth - это новый подход к fine-tuning'у диффузионных text-to-image моделей, который позволяет создавать фотореалистичные изображения объекта в новом контексте на основе всего нескольких изображений этого объекта.

В данной работе авторы представили новый подход к "персонализации" text-to-image моделей, адаптируя их к потребностям конкретного пользователя. Целью является расширение пространства имён модели таким образом, чтобы она связывала новые слова с конкретными объектами, которые пользователь хочет сгенерировать. Используя в качестве входных данных всего несколько изображений объекта, предобученная модель дообучается таким образом, чтобы она научилась привязывать уникальный идентификатор к этому конкретному объекту. Как только объект встроен, уникальный идентификатор может быть использован для синтеза новых фотореалистичных изображений объекта, контекстуализированных в различных сценах, сохраняя при этом их ключевые отличительные черты. 

Для этого авторы исполльзуют fine-tuning text-to-image модели с помощью входных изображений и текстовых промптов, содержащих уникальный идентификатор, за которым следует название класса объекта (например, "A [V] dog"). Последнее позволяет модели использовать свои предварительные знания о классе объекта, в то время как экземпляр, относящийся к конкретному классу, привязан к уникальному идентификатору. Чтобы предотвратить уменьшение разнообразия в генерации изображений и так называемый language drift, который приводит к тому, что модель связывает имя класса с конкретным экземпляром, авторы предлагают Prior Preservation Loss, который использует семантические знания модели о классе и побуждает её генерировать различные экземпляры того же класса, что и наш объект.

Авторы утверждают, что данная технология является первой, которая решает проблему создания изображений на основе объектов, позволяя пользователям из нескольких случайно сделанных изображений объекта генерировать новые изображения объекта в различных сценах, позах и условиях освещения, которые не появляются на эталонных изображениях, сохраняя при этом его отличительные особенности.

Применение данного подхода открывает дорогу к множеству приложений для создания изображений на основе текста, включая реконтекстуализацию объектов, модификацию их свойств, оригинальное художественное оформление и многое другое.